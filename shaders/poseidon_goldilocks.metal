#ifndef poseidon2_goldilocks
#define poseidon2_goldilocks
#include <metal_stdlib>
#include "goldilocks.metal"
#include "u128.h.metal"
#include "poseidon_goldilocks_mds.metal"

using namespace metal;
namespace GoldilocksField {

constant const ulong POSEIDON_MDS_MATRIX_CIRC[12] = {
  17, 15, 41, 16, 2, 28, 13, 13, 39, 18, 34, 20
};
constant const Fp POSEIDON_RC12[30][12] = {
  {Fp(13080132714287612933),Fp(8594738767457295063),Fp(12896916465481390516),Fp(1109962092811921367),Fp(16216730422861946898),Fp(10137062673499593713),Fp(15292064466732465823),Fp(17255573294985989181),Fp(14827154241873003558),Fp(2846171647972703231),Fp(16246264663680317601),Fp(14214208087951879286)},
  {Fp(9667108687426275457),Fp(6470857420712283733),Fp(14103331940138337652),Fp(11854816473550292865),Fp(3498097497301325516),Fp(7947235692523864220),Fp(11110078701231901946),Fp(16384314112672821048),Fp(15404405912655775739),Fp(14077880830714445579),Fp(9555554662709218279),Fp(13859595358210603949)},
  {Fp(16859897325061800066),Fp(17685474420222222349),Fp(17858764734618734949),Fp(9410011022665866671),Fp(12495243629579414666),Fp(12416945298171515742),Fp(5776666812364270983),Fp(6314421662864060481),Fp(7402742471423223171),Fp(982536713192432718),Fp(17321168865775127905),Fp(2934354895005980211)},
  {Fp(10567510598607410195),Fp(8135543733717919110),Fp(116353493081713692),Fp(8029688163494945618),Fp(9003846637224807585),Fp(7052445132467233849),Fp(9645665432288852853),Fp(5446430061030868787),Fp(16770910634346036823),Fp(17708360571433944729),Fp(4661556288322237631),Fp(11977051899316327985)},
  {Fp(4378616569090929672),Fp(3334807502817538491),Fp(8019184735943344966),Fp(2395043908812246395),Fp(6558421058331732611),Fp(11735894060727326369),Fp(8143540538889204488),Fp(5991753489563751169),Fp(12235918791502088007),Fp(2880312033702687139),Fp(18224748115308382355),Fp(18070411013125314165)},
  {Fp(8156487614120951180),Fp(10615269510047010719),Fp(12489426404754222075),Fp(5055279340069995710),Fp(7231927319780248664),Fp(2602078848106763799),Fp(12445944369334781425),Fp(3978905923892496205),Fp(16711272944329818038),Fp(10439032361227108922),Fp(15110119871725214866),Fp(821141790655890946)},
  {Fp(11073536380651186235),Fp(4866839313097607757),Fp(13118391689513956636),Fp(14527674973762312380),Fp(7612751959265567999),Fp(6808090907814178161),Fp(6899703779492644997),Fp(3664666286336986826),Fp(783179505424462608),Fp(8990689241814097697),Fp(9646603555412825679),Fp(7351246026167205041)},
  {Fp(16970959813722173256),Fp(15735726858241466429),Fp(10347018221892268419),Fp(12195545878449322889),Fp(7423314197114049891),Fp(14908016116973904153),Fp(5840340122527363265),Fp(17740311462440614128),Fp(815306421953744623),Fp(17456357368219253949),Fp(6982651076559329072),Fp(11970987324614963868)},
  {Fp(8167785008538063246),Fp(9483259819397403968),Fp(954550221664291548),Fp(10339565171024313256),Fp(8651171084286500102),Fp(16974445528003515956),Fp(15104530047940621190),Fp(103271880867179718),Fp(14654666245504492663),Fp(12445769555936887967),Fp(11250582358051997490),Fp(6730977207490590241)},
  {Fp(15919951556166196935),Fp(4423540216573360915),Fp(16317664700341473511),Fp(4723997214951767765),Fp(10098756619006575500),Fp(3223149401237667964),Fp(6870494874300767682),Fp(2902095711130291898),Fp(7159372652788439733),Fp(11500508372997952671),Fp(13348148181479462670),Fp(12729401155983882093)},
  {Fp(15021242795466053388),Fp(3802990509227527157),Fp(4665459515680145682),Fp(13165553315407675603),Fp(6496364397926233172),Fp(12800832566287577810),Fp(9737592377590267426),Fp(8687131091302514939),Fp(1488200421755445892),Fp(11004377668730991641),Fp(13516338734600228410),Fp(2953581820660217936)},
  {Fp(3505040783153922951),Fp(3710332827435113697),Fp(15414874040873320221),Fp(8602547649919482301),Fp(13971349938398812007),Fp(187239246702636066),Fp(12886019973971254144),Fp(4512274763990493707),Fp(2986635507805503192),Fp(2315252455709119454),Fp(12537995864054210246),Fp(2039491936479859267)},
  {Fp(1558644089185031256),Fp(4074089203264759305),Fp(2522268501749395707),Fp(3414760436185256196),Fp(17420887529146466921),Fp(2817020417938125001),Fp(16538346563888261485),Fp(5592270336833998770),Fp(16876602064684906232),Fp(1793025614521516343),Fp(2178510518148748532),Fp(2726440714374752509)},
  {Fp(6502946837278398021),Fp(15816362857667988792),Fp(12997958454165692924),Fp(5314892854495903792),Fp(15533907063555687782),Fp(12312015675698548715),Fp(14140016464013350248),Fp(16325589062962838690),Fp(6796145646370327654),Fp(1168753512742361735),Fp(4100789820704709368),Fp(15947554381540469177)},
  {Fp(8597377839806076919),Fp(9704018824195918000),Fp(12763288618765762688),Fp(17249257732622847695),Fp(1998710993415069759),Fp(923759906393011543),Fp(1271051229666811593),Fp(17822362132088738077),Fp(11797234543722669271),Fp(5864538787265942447),Fp(15975583211110506970),Fp(7258516085733671960)},
  {Fp(17999926471875633100),Fp(635992114476018166),Fp(17205047318256576347),Fp(17384900867876315312),Fp(16484825562915784226),Fp(16694130609036138894),Fp(10575069350371260875),Fp(8330575162062887277),Fp(6212375704691932880),Fp(15965138197626618226),Fp(14285453069600046939),Fp(10005163510208402517)},
  {Fp(885298637936952595),Fp(541790758138118921),Fp(5985203084790372993),Fp(4685030219775483721),Fp(1411106851304815020),Fp(11290732479954096478),Fp(208280581124868513),Fp(10979018648467968495),Fp(8600643745023338215),Fp(3477453626867126061),Fp(6428436309340258604),Fp(5695415667275657934)},
  {Fp(15952065508715623490),Fp(15571300830419767248),Fp(17259785660502616862),Fp(4298425495274316083),Fp(9023601070579319352),Fp(7353589709321807492),Fp(2988848909076209475),Fp(10439527789422046135),Fp(6097734044161429459),Fp(1113429873817861476),Fp(1639063372386966591),Fp(7863102812716788759)},
  {Fp(216040220732135364),Fp(14252611488623712688),Fp(9543395466794536974),Fp(2714461051639810934),Fp(2588317208781407279),Fp(15458529123534594916),Fp(15748417817551040856),Fp(16414455697114422951),Fp(13378164466674639511),Fp(13894319928411294675),Fp(5032680892090751540),Fp(17201338494743078916)},
  {Fp(4397422800601932505),Fp(11285062031581972327),Fp(7309354640676468207),Fp(10457152817239331848),Fp(8855911538863247046),Fp(4301853449821814398),Fp(13001502396339103326),Fp(10218424535115580246),Fp(8628244713920681895),Fp(17410423622514037261),Fp(14080683768439215375),Fp(11453161143447188100)},
  {Fp(16761509772042181939),Fp(6688821660695954082),Fp(12083434295263160416),Fp(8540021431714616589),Fp(6891616215679974226),Fp(10229217098454812721),Fp(3292165387203778711),Fp(6090113424998243490),Fp(13431780521962358660),Fp(6061081364215809883),Fp(16792066504222214142),Fp(16134314044798124799)},
  {Fp(17070233710126619765),Fp(6915716851370550800),Fp(9505009849073026581),Fp(6422700465081897153),Fp(17977653991560529185),Fp(5800870252836247255),Fp(12096124733159345520),Fp(7679273623392321940),Fp(17835783910585744964),Fp(2478664878205754377),Fp(1720314468413114967),Fp(10376757819003248056)},
  {Fp(10376377187857634245),Fp(13344930747504284997),Fp(11579281865160153596),Fp(10300256980048736962),Fp(378765236515040565),Fp(11412420941557253424),Fp(12931662470734252786),Fp(43018908376346374),Fp(3589810689190160071),Fp(4688229274750659741),Fp(13688957436484306091),Fp(11424740943016984272)},
  {Fp(16001900718237913960),Fp(5548469743008097574),Fp(14584404916672178680),Fp(3396622135873576824),Fp(7861729246871155992),Fp(16112271126908045545),Fp(16988163966860016012),Fp(273641680619529493),Fp(15222677154027327363),Fp(4070328078309830604),Fp(13520458500363296391),Fp(8235111705801363015)},
  {Fp(5575990058472514138),Fp(2751301609188252989),Fp(6478598528223547074),Fp(386565553848556638),Fp(9417729078939938713),Fp(15204315939835727483),Fp(14942015033780606261),Fp(18369423901636582012),Fp(4715338437538604447),Fp(6840590980607806319),Fp(5535471161490539014),Fp(5341328005359029952)},
  {Fp(1475161295215894444),Fp(7999197814297036636),Fp(2984233088665867938),Fp(3097746028144832229),Fp(8849530863480031517),Fp(7464920943249009773),Fp(3802996844641460514),Fp(6284458522545927646),Fp(2307388003445002779),Fp(4461479354745457623),Fp(1649739722664588460),Fp(3008391274160432867)},
  {Fp(5142217010456550622),Fp(1775580461722730120),Fp(161694268822794344),Fp(1518963253808031703),Fp(16475258091652710137),Fp(119575899007375159),Fp(1275863735937973999),Fp(16539412514520642374),Fp(2303365191438051950),Fp(6435126839960916075),Fp(17794599201026020053),Fp(13847097589277840330)},
  {Fp(16645869274577729720),Fp(8039205965509554440),Fp(4788586935019371140),Fp(15129007200040077746),Fp(2055561615223771341),Fp(4149731103701412892),Fp(10268130195734144189),Fp(13406631635880074708),Fp(11429218277824986203),Fp(15773968030812198565),Fp(16050275277550506872),Fp(11858586752031736643)},
  {Fp(8927746344866569756),Fp(11802068403177695792),Fp(157833420806751556),Fp(4698875910749767878),Fp(1616722774788291698),Fp(3990951895163748090),Fp(16758609224720795472),Fp(3045571693290741477),Fp(9281634245289836419),Fp(13517688176723875370),Fp(7961395585333219380),Fp(1606574359105691080)},
  {Fp(17564372683613562171),Fp(4664015225343144418),Fp(6133721340680280128),Fp(2667022304383014929),Fp(12316557761857340230),Fp(10375614850625292317),Fp(8141542666379135068),Fp(9185476451083834432),Fp(4991072365274649547),Fp(17398204971778820365),Fp(16127888338958422584),Fp(13586792051317758204)},
};

inline ulong poseidon_mds_row_shf_0(thread Fp* p2_state){
  u128 res = u128(0);

  #pragma unroll
  for(int i=0;i<12;i++){
    res.accumulate_mul_2_ulong(static_cast<ulong>(p2_state[i%12]), POSEIDON_MDS_MATRIX_CIRC[i]);
  }
  res.accumulate_mul_2_ulong(static_cast<ulong>(p2_state[0]), 8);
  ulong reduced = reduce128(res.high, res.low);
  return reduced<GOLDILOCKS_PRIME?reduced:(reduced-GOLDILOCKS_PRIME);
}
inline ulong poseidon_mds_row_shf(int r, thread Fp* p2_state){
  u128 res = u128(0);

  #pragma unroll
  for(int i=0;i<12;i++){
    res.accumulate_mul_2_ulong(static_cast<ulong>(p2_state[(i+r)%12]), POSEIDON_MDS_MATRIX_CIRC[i]);
  }
  ulong reduced = reduce128(res.high, res.low);
  return reduced<GOLDILOCKS_PRIME?reduced:(reduced-GOLDILOCKS_PRIME);
}
inline void poseidon_mds_layer_old(thread Fp* p2_state){
  ulong result[12];
  result[0] = poseidon_mds_row_shf_0(p2_state);

  #pragma unroll
  for(int i=1;i<12;i++){
    result[i] = poseidon_mds_row_shf(i, p2_state);
  }
  #pragma unroll
  for(int i=0;i<12;i++){
    p2_state[i] = Fp(result[i]);
  }
}

inline void poseidon_mds_layer(thread Fp* p2_state){
  apply_mds_freq(p2_state,0);
}

inline void poseidon_add_rc(thread Fp* p2_state, int roundIndex) {
  #pragma unroll
  for (int i = 0; i<12; i++) {
    p2_state[i] = p2_state[i]+ POSEIDON_RC12[roundIndex][i];
  }
}
inline void poseidon_sbox_all(thread Fp* p2_state) {
  #pragma unroll
  for (int i = 0; i<12; i++) {
    p2_state[i] = p2_state[i].pow7();
  }
}
inline void poseidon_full_round(thread Fp* p2_state, int roundIndex) {
  poseidon_add_rc(p2_state, roundIndex);
  poseidon_sbox_all(p2_state);
  poseidon_mds_layer(p2_state);
}
inline void poseidon_partial_round(thread Fp* p2_state, int roundIndex) {
  poseidon_add_rc(p2_state, roundIndex);
  p2_state[0] = p2_state[0].pow7();
  poseidon_mds_layer(p2_state);
}
inline void poseidon_permute(thread Fp* p2_state){
  

  #pragma unroll
  for (int i = 0; i < 4; i++) {
    poseidon_full_round(p2_state, i);
  }

  #pragma unroll
  for (int i = 4; i < 26; i++) {
    poseidon_partial_round(p2_state, i);
  }

  #pragma unroll
  for (int i = 26; i < 30; i++) {
    poseidon_full_round(p2_state, i);
  }
}

}

#endif